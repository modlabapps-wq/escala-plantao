<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Escala Fiscais ‚Ä¢ Linhas</title>

  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- html2canvas (print do calend√°rio) -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <!-- jsPDF (exportar PDF real, sem ‚Äúimprimir‚Äù) -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    :root{
      /* TEMA CLARO VERDE */
      --bg0:#eafff2;
      --bg1:#d9ffe9;

      --panel:rgba(255,255,255,.78);
      --panel2:rgba(255,255,255,.92);
      --border:rgba(0,0,0,.12);

      --text:#0b1f14;
      --muted:#365a47;
      --muted2:#4f7b64;

      /* ‚ÄúNeon‚Äù suave */
      --c1:#00c46a;  /* verde */
      --c2:#00a6ff;  /* azul */
      --c3:#8a2be2;  /* roxo */

      /* status chips */
      --k-trabalho-bg:#c9ffe0;
      --k-trabalho-br:#00c46a;

      --k-plantao-bg:#cfefff;
      --k-plantao-br:#00a6ff;

      --k-ferias-bg:#ffe2f0;
      --k-ferias-br:#ff3ea8;

      --k-folga-bg:#fff3c8;
      --k-folga-br:#f3b700;

      --k-cobertura-bg:#e6dbff;
      --k-cobertura-br:#8a2be2;

      --radius:18px;
      --shadow: 0 12px 28px rgba(0,0,0,.12);
      --shadow2: 0 10px 24px rgba(0,0,0,.10);

      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(900px 520px at 20% 10%, rgba(0,196,106,.18), transparent 55%),
        radial-gradient(900px 520px at 75% 15%, rgba(0,166,255,.12), transparent 55%),
        radial-gradient(900px 520px at 60% 92%, rgba(138,43,226,.10), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }

    .hidden{ display:none !important; }

    .wrap{
      width: min(1480px, 100%);
      margin: 0 auto;
      padding: 18px 14px 22px;
    }

    /* Topbar responsivo e ‚Äúnatural‚Äù na tela */
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
      padding: 12px 12px;
      border-radius: 18px;
      border:1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,.82), rgba(255,255,255,.62));
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }

    .brand{
      display:flex;
      align-items:center;
      gap:12px;
      padding: 8px 10px;
      border-radius: 999px;
      border:1px solid rgba(0,0,0,.10);
      background: rgba(255,255,255,.75);
    }
    .dot{
      width:12px;height:12px;border-radius:50%;
      background: radial-gradient(circle at 30% 30%, #fff, rgba(255,255,255,.2));
      border:1px solid rgba(0,0,0,.12);
      box-shadow:
        0 0 18px rgba(0,196,106,.25),
        0 0 18px rgba(0,166,255,.18),
        0 0 18px rgba(138,43,226,.14);
    }
    .brand h1{ margin:0; font-size: 14px; letter-spacing:.2px; font-weight: 900; }
    .brand span{ display:block; font-size:12px; color: var(--muted); margin-top: 2px; font-weight: 700; }

    .actions{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
      margin-left:auto;
    }

    .pill{
      padding: 9px 10px;
      border-radius: 14px;
      border:1px solid rgba(0,0,0,.10);
      background: rgba(255,255,255,.72);
      box-shadow: var(--shadow2);
      display:flex;
      align-items:center;
      gap:8px;
    }
    .pill b{ font-size:12px; color:var(--muted); letter-spacing:.15px; }

    .input, .select{
      border:1px solid rgba(0,0,0,.12);
      background: rgba(255,255,255,.85);
      color: var(--text);
      border-radius: 12px;
      padding: 10px 12px;
      outline:none;
      min-width: 200px;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.04);
    }
    .input::placeholder{ color: rgba(54,90,71,.65); }
    .select{ min-width: 170px; cursor:pointer; }

    .btn{
      appearance:none;
      border:1px solid rgba(0,0,0,.14);
      background: rgba(255,255,255,.78);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      cursor:pointer;
      font-weight: 900;
      letter-spacing: .2px;
      transition: transform .06s ease, filter .15s ease, border-color .15s ease;
      box-shadow: var(--shadow2);
      display:inline-flex;
      align-items:center;
      gap:8px;
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{ filter: brightness(1.03); border-color: rgba(0,0,0,.20); }
    .btn:active{ transform: translateY(1px); }

    .btn.green{ border-color: rgba(0,196,106,.35); box-shadow: var(--shadow2), 0 0 18px rgba(0,196,106,.18); }
    .btn.blue{ border-color: rgba(0,166,255,.30); box-shadow: var(--shadow2), 0 0 18px rgba(0,166,255,.16); }
    .btn.purple{ border-color: rgba(138,43,226,.28); box-shadow: var(--shadow2), 0 0 18px rgba(138,43,226,.14); }
    .btn.danger{ border-color: rgba(255,77,109,.28); }

    .grid{ display:grid; grid-template-columns: 1fr; gap: 12px; margin-top: 12px; }

    .card{
      border:1px solid rgba(0,0,0,.12);
      background: linear-gradient(180deg, rgba(255,255,255,.85), rgba(255,255,255,.70));
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      overflow:hidden;
    }
    .card .head{
      padding: 12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom:1px solid rgba(0,0,0,.08);
      flex-wrap: wrap;
    }
    .card .head h2{ margin:0; font-size: 14px; letter-spacing:.2px; font-weight: 950; }
    .card .body{ padding: 12px 14px; }

    .muted{ color: var(--muted); font-weight:700; }

    .table-wrap{
      overflow:auto;
      border-radius: 14px;
      border:1px solid rgba(0,0,0,.10);
      background: rgba(255,255,255,.68);
    }

    table{
      border-collapse: separate;
      border-spacing: 0;
      width: 100%;
      min-width: 980px;
      font-size: 12.5px;
      color: var(--text);
    }

    thead th{
      position: sticky;
      top:0;
      z-index: 2;
      background: rgba(255,255,255,.92);
      border-bottom:1px solid rgba(0,0,0,.10);
      text-align:left;
      padding: 10px 10px;
      white-space:nowrap;
      font-weight: 950;
      letter-spacing:.15px;
    }

    tbody td{
      border-bottom: 1px solid rgba(0,0,0,.06);
      padding: 8px 10px;
      vertical-align: middle;
      white-space:nowrap;
    }

    tbody tr:hover{ background: rgba(0,196,106,.06); }

    .col-driver{
      min-width: 380px;
      position: sticky;
      left:0;
      z-index: 1;
      background: rgba(255,255,255,.94);
      border-right:1px solid rgba(0,0,0,.10);
    }
    thead .col-driver{ z-index: 3; border-right:1px solid rgba(0,0,0,.12); }

    .driver-title{ display:flex; flex-direction:column; gap:6px; }
    .driver-title .name{ font-weight: 950; letter-spacing:.15px; font-size: 13px; }
    .driver-meta{ display:flex; flex-wrap:wrap; gap:8px; }

    .tag{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 5px 8px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,.12);
      background: rgba(255,255,255,.78);
      font-size: 12px;
      font-weight: 900;
      color: var(--text);
    }

    /* Chips do m√™s */
    .chip{
      display:flex;
      flex-direction:column;
      align-items:flex-start;
      justify-content:center;
      border-radius: 12px;
      padding: 8px 10px;
      border:1px solid rgba(0,0,0,.12);
      background: rgba(255,255,255,.75);
      min-width: 90px;
      max-width: 168px; /* evita ‚Äúestic√£o‚Äù */
      cursor:pointer;
      user-select:none;
      transition: transform .06s ease, filter .15s ease;
      white-space: normal; /* quebra */
      line-height: 1.15;
      gap: 4px;
    }
    .chip:hover{ filter: brightness(1.02); }
    .chip:active{ transform: translateY(1px); }

    .chip .main{
      font-weight: 950;
      overflow:hidden;
      display:-webkit-box;
      -webkit-line-clamp: 2;   /* no m√°ximo 2 linhas */
      -webkit-box-orient: vertical;
      word-break: break-word;
    }
    .chip .sub{
      font-size: 11px;
      font-weight: 800;
      color: rgba(11,31,20,.75);
      overflow:hidden;
      display:-webkit-box;
      -webkit-line-clamp: 1;
      -webkit-box-orient: vertical;
      word-break: break-word;
    }

    .chip.empty{
      border-style:dashed;
      color: rgba(11,31,20,.55);
      background: rgba(255,255,255,.62);
      align-items:center;
    }

    .chip.k-trabalho{ background: var(--k-trabalho-bg); border-color: rgba(0,196,106,.50); }
    .chip.k-plantao{ background: var(--k-plantao-bg); border-color: rgba(0,166,255,.55); }
    .chip.k-ferias{ background: var(--k-ferias-bg); border-color: rgba(255,62,168,.55); }
    .chip.k-folga{ background: var(--k-folga-bg); border-color: rgba(243,183,0,.60); }
    .chip.k-cobertura{ background: var(--k-cobertura-bg); border-color: rgba(138,43,226,.55); }

    /* Drawer: abre j√° em tela cheia */
    .drawer{
      position: fixed;
      inset: 14px;
      background: rgba(255,255,255,.92);
      border:1px solid rgba(0,0,0,.12);
      box-shadow: 0 20px 70px rgba(0,0,0,.22);
      border-radius: 18px;
      display:none;
      flex-direction:column;
      z-index: 50;
      overflow:hidden;
      backdrop-filter: blur(12px);
    }
    .drawer.open{ display:flex; }

    .drawer .d-head{
      padding: 12px 14px;
      border-bottom: 1px solid rgba(0,0,0,.10);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 10px;
      flex-wrap: wrap;
      background: linear-gradient(180deg, rgba(255,255,255,.95), rgba(255,255,255,.78));
    }
    .drawer .d-title{ display:flex; flex-direction:column; gap:6px; }
    .drawer .d-title .big{ font-weight: 1000; letter-spacing:.15px; font-size: 14px; }
    .drawer .d-title .sub{
      color: var(--muted);
      font-size: 12.5px;
      display:flex;
      flex-wrap:wrap;
      gap: 8px;
      font-weight: 800;
    }
    .drawer .d-body{ padding: 12px 14px; overflow:auto; flex:1; }

    /* Calend√°rio */
    .calendar{
      border:1px solid rgba(0,0,0,.10);
      border-radius: 16px;
      overflow:hidden;
      background: rgba(255,255,255,.85);
    }
    .cal-head{
      display:grid;
      grid-template-columns: repeat(7,1fr);
      background: rgba(0,196,106,.08);
      border-bottom:1px solid rgba(0,0,0,.08);
    }
    .cal-head div{
      padding: 10px 10px;
      font-weight: 1000;
      font-size: 12px;
      color: #0b1f14;
      text-align:center;
    }
    .cal-grid{
      display:grid;
      grid-template-columns: repeat(7,1fr);
    }
    .day{
      min-height: 106px;
      border-right:1px solid rgba(0,0,0,.06);
      border-bottom:1px solid rgba(0,0,0,.06);
      padding: 10px 10px;
      display:flex;
      flex-direction:column;
      gap:10px;
      cursor:pointer;
      user-select:none;
    }
    .day:nth-child(7n){ border-right:none; }
    .day .num{
      font-family: var(--mono);
      font-size: 12px;
      color: rgba(54,90,71,.8);
      font-weight: 900;
    }
    .day .val{
      display:flex;
      flex-direction:column;
      gap:4px;
      border-radius: 12px;
      padding: 8px 10px;
      border:1px solid rgba(0,0,0,.12);
      background: rgba(255,255,255,.85);
      font-size: 12.5px;
      max-width: 100%;
      white-space: normal;
      line-height: 1.15;
    }
    .day .val .main{
      font-weight: 1000;
      overflow:hidden;
      display:-webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      word-break: break-word;
    }
    .day .val .sub{
      font-size: 11px;
      font-weight: 850;
      color: rgba(11,31,20,.70);
      overflow:hidden;
      display:-webkit-box;
      -webkit-line-clamp: 1;
      -webkit-box-orient: vertical;
      word-break: break-word;
    }

    .day .val.empty{
      border-style:dashed;
      background: rgba(255,255,255,.72);
      color: rgba(11,31,20,.55);
    }
    .day:hover{ background: rgba(0,196,106,.06); }
    .day.muted{ opacity:.35; cursor: default; }
    .day.muted:hover{ background: transparent; }

    /* Modal */
    .overlay{
      position: fixed;
      inset:0;
      background: rgba(0,0,0,.35);
      backdrop-filter: blur(6px);
      display:none;
      align-items:center;
      justify-content:center;
      z-index: 100;
      padding: 18px;
    }
    .overlay.show{ display:flex; }
    .modal{
      width: min(620px, 96vw);
      border-radius: 18px;
      border:1px solid rgba(0,0,0,.14);
      background: rgba(255,255,255,.95);
      box-shadow: 0 18px 50px rgba(0,0,0,.22);
      overflow:hidden;
    }
    .modal .m-head{
      padding: 12px 14px;
      border-bottom:1px solid rgba(0,0,0,.10);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }
    .modal .m-head h3{ margin:0; font-size: 14px; letter-spacing:.15px; font-weight: 1000; }
    .modal .m-body{ padding: 12px 14px; }
    .modal .m-actions{
      padding: 12px 14px;
      border-top:1px solid rgba(0,0,0,.10);
      display:flex;
      justify-content:flex-end;
      gap: 10px;
      flex-wrap: wrap;
    }

    .row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 10px;
    }
    .row .full{ grid-column: 1 / -1; }
    label{
      display:block;
      font-size: 12px;
      color: var(--muted);
      margin: 0 0 6px;
      letter-spacing:.15px;
      font-weight: 950;
    }

    .help{
      margin-top: 8px;
      font-size: 12px;
      color: rgba(54,90,71,.85);
      line-height: 1.35;
      font-weight: 750;
    }

    /* Login */
    .login{
      min-height: 100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 18px 14px;
    }
    .login-card{
      width: min(560px, 96vw);
      border-radius: 20px;
      border:1px solid rgba(0,0,0,.14);
      background: rgba(255,255,255,.88);
      box-shadow: 0 18px 50px rgba(0,0,0,.20);
      overflow:hidden;
    }
    .login-head{
      padding: 16px 16px 12px;
      border-bottom:1px solid rgba(0,0,0,.10);
      display:flex;
      gap: 12px;
      align-items:center;
    }
    .badge{
      width: 46px; height: 46px;
      border-radius: 16px;
      border:1px solid rgba(0,0,0,.12);
      background:
        radial-gradient(circle at 30% 30%, rgba(255,255,255,.95), transparent 45%),
        linear-gradient(135deg, rgba(0,196,106,.22), rgba(0,166,255,.18));
      box-shadow:
        0 0 18px rgba(0,196,106,.14),
        0 0 18px rgba(0,166,255,.12);
    }
    .login-head h2{ margin:0; font-size: 15px; letter-spacing:.15px; font-weight: 1000; }
    .login-head p{ margin: 4px 0 0; color: var(--muted); font-size: 12.5px; line-height: 1.35; font-weight: 750; }
    .login-body{ padding: 14px 16px 16px; }
    .login-actions{
      display:flex;
      justify-content:flex-end;
      gap: 10px;
      flex-wrap:wrap;
      padding: 0 16px 16px;
    }
    .err{ margin-top: 10px; color: #b4002d; font-size: 12.5px; display:none; font-weight: 900; }

    /* Modo captura: deixa tudo ‚Äúalto contraste‚Äù no PNG */
    body.capture-mode{
      background: #ffffff !important;
    }
    body.capture-mode .card,
    body.capture-mode .calendar{
      background: #ffffff !important;
      box-shadow:none !important;
    }
    body.capture-mode .cal-head{ background: #f2fff8 !important; }
    body.capture-mode .day{ background:#fff !important; }
    body.capture-mode .day:hover{ background:#fff !important; }
    body.capture-mode .day .val{ background:#fff !important; border-color:#000 !important; }
    body.capture-mode .day .num{ color:#000 !important; }

    @media (max-width: 980px){
      .input{ min-width: 170px; }
      .select{ min-width: 160px; }
      table{ min-width: 980px; }
      .drawer{ inset: 10px; }
    }
    @media (max-width: 720px){
      .row{ grid-template-columns: 1fr; }
      .drawer{ inset: 8px; }
      .day{ min-height: 96px; }
    }
  </style>
</head>

<body>
  <!-- LOGIN -->
  <section id="loginView" class="login">
    <div class="login-card">
      <div class="login-head">
        <div class="badge" aria-hidden="true"></div>
        <div>
          <h2>Escala Fiscais ‚Ä¢ Linhas</h2>
          <p>Login √∫nico (Supabase Auth). Dados ficam na nuvem (n√£o apaga ‚Äúdo nada‚Äù).</p>
        </div>
      </div>
      <div class="login-body">
        <div class="row">
          <div class="full">
            <label>E-mail</label>
            <input id="loginEmail" class="input" placeholder="ex: darlene.plantao@pessegotransportes.com.br" autocomplete="username"/>
          </div>
          <div class="full">
            <label>Senha</label>
            <input id="loginPass" class="input" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password"/>
          </div>
        </div>
        <div id="loginErr" class="err">N√£o foi poss√≠vel entrar. Verifique e-mail/senha.</div>
        <div class="help">
          ‚úÖ Depois de logar: cadastre os fiscais e monte o m√™s. Clique no <b>nome</b> para abrir o calend√°rio em tela cheia.
        </div>
      </div>
      <div class="login-actions">
        <button id="btnLogin" class="btn green">Entrar</button>
      </div>
    </div>
  </section>

  <!-- APP -->
  <main id="appView" class="hidden">
    <div class="wrap">
      <div class="topbar">
        <div class="brand">
          <div class="dot" aria-hidden="true"></div>
          <div>
            <h1>Escala Fiscais</h1>
            <span>por linha ‚Ä¢ cobertura autom√°tica ‚Ä¢ exporta√ß√£o</span>
          </div>
        </div>

        <div class="actions">
          <div class="pill">
            <b>M√™s</b>
            <input id="monthPicker" class="input" type="month" style="min-width:160px"/>
          </div>

          <div class="pill">
            <b>Tipo</b>
            <select id="roleFilter" class="select">
              <option value="todos">Todos</option>
              <option value="fixo">fixo</option>
              <option value="plantonista">plantonista</option>
            </select>
          </div>

          <div class="pill">
            <b>Linha</b>
            <select id="lineFilter" class="select">
              <option value="todas">Todas</option>
            </select>
          </div>

          <div class="pill">
            <b>Status</b>
            <select id="coverageFilter" class="select" style="min-width:210px">
              <option value="todos">Tudo</option>
              <option value="folgas_faltando">Folgas faltando cobrir</option>
              <option value="folgas_cobertas">Folgas j√° cobertas</option>
            </select>
          </div>

          <div class="pill">
            <b>Buscar</b>
            <input id="searchMat" class="input" placeholder="matr√≠cula ou nome"/>
          </div>

          <button id="btnExportCSV" class="btn blue">üìÑ Excel (CSV)</button>
          <button id="btnExportPDF" class="btn purple">üßæ PDF</button>
          <button id="btnAddDriver" class="btn green">+ Cadastrar fiscal</button>
          <button id="btnLogout" class="btn danger">Sair</button>
        </div>
      </div>

      <div class="grid">
        <section class="card">
          <div class="head">
            <h2>Visualiza√ß√£o 1 ‚Ä¢ Lista do m√™s (todos os fiscais)</h2>
            <div class="muted" style="font-size:12px;">
              Clique no nome ‚Üí calend√°rio ‚Ä¢ clique em um dia ‚Üí editar (tipo, linha, hora, cobertura)
            </div>
          </div>
          <div class="body">
            <div class="table-wrap">
              <table id="monthTable">
                <thead id="monthThead"></thead>
                <tbody id="monthTbody"></tbody>
              </table>
            </div>
          </div>
        </section>
      </div>

      <div id="footerStatus" class="muted" style="margin-top:10px;font-size:12px;font-weight:900;">
        ‚è≥ Conectando‚Ä¶
      </div>
    </div>
  </main>

  <!-- DRAWER (tela cheia) -->
  <aside id="drawer" class="drawer" aria-hidden="true">
    <div class="d-head">
      <div class="d-title">
        <div id="dName" class="big">Fiscal</div>
        <div id="dSub" class="sub"></div>
      </div>
      <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end;">
        <button id="btnPng" class="btn blue">üñºÔ∏è Baixar PNG (calend√°rio)</button>
        <button id="btnPdfCal" class="btn purple">üßæ PDF (calend√°rio)</button>
        <button id="btnRemoveDriver" class="btn danger">Remover</button>
        <button id="btnCloseDrawer" class="btn">Sair</button>
      </div>
    </div>

    <div class="d-body">
      <!-- captur√°vel -->
      <div id="calCapture">
        <div class="card" style="border-radius:16px;">
          <div class="head">
            <h2>Visualiza√ß√£o 2 ‚Ä¢ Calend√°rio do m√™s</h2>
            <div class="muted" style="font-size:12px;">Clique em um dia para editar</div>
          </div>
          <div class="body">
            <div class="calendar">
              <div class="cal-head">
                <div>DOM</div><div>SEG</div><div>TER</div><div>QUA</div><div>QUI</div><div>SEX</div><div>S√ÅB</div>
              </div>
              <div id="calGrid" class="cal-grid"></div>
            </div>

            <div class="help" style="margin-top:10px;">
              Tipos: <b>Trabalho</b>, <b>Plant√£o</b>, <b>F√©rias</b>, <b>Folga</b>, <b>Cobertura</b>.<br/>
              Formato recomendado: <span style="font-family:var(--mono)">linha</span> + <span style="font-family:var(--mono)">hora</span> (ex: <span style="font-family:var(--mono)">3013-10</span> ‚Ä¢ <span style="font-family:var(--mono)">14:00</span>).
            </div>
          </div>
        </div>
      </div>

      <div class="help" style="margin-top:10px;">
        ‚úÖ PNG sai ‚Äúalto contraste‚Äù e sem cortar (modo captura).
      </div>
    </div>
  </aside>

  <!-- MODAL: Add Driver -->
  <div id="addOverlay" class="overlay" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="m-head">
        <h3>Cadastrar fiscal</h3>
        <button id="btnCloseAdd" class="btn">Fechar</button>
      </div>
      <div class="m-body">
        <div class="row">
          <div>
            <label>Matr√≠cula</label>
            <input id="inMat" class="input" placeholder="ex: 30333" />
          </div>
          <div>
            <label>Tipo</label>
            <select id="inRole" class="select">
              <option value="fixo">fixo</option>
              <option value="plantonista">plantonista</option>
            </select>
          </div>

          <div class="full">
            <label>Nome</label>
            <input id="inName" class="input" placeholder="Nome completo" />
          </div>

          <div class="full">
            <label>Telefone (opcional)</label>
            <input id="inPhone" class="input" placeholder="(se quiser)" />
          </div>

          <div>
            <label>Linha fixa (se for fixo)</label>
            <input id="inLineDefault" class="input" placeholder="ex: 3013-10" />
          </div>
          <div>
            <label>Status (edit√°vel)</label>
            <input id="inStatus" class="input" placeholder="ex: Dispon√≠vel / Cobrindo f√©rias" />
          </div>

          <div class="full">
            <div class="help">
              Dica: voc√™ pode editar <b>Status</b> e <b>Linha fixa</b> depois, clicando no nome ‚Üí bot√£o ‚ÄúEditar fiscal‚Äù.
            </div>
          </div>
        </div>

        <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;">
          <button id="btnEditDriver" class="btn blue hidden">‚úèÔ∏è Editar fiscal</button>
        </div>
      </div>
      <div class="m-actions">
        <button id="btnSaveDriver" class="btn green">Salvar</button>
      </div>
    </div>
  </div>

  <!-- MODAL: Edit Day -->
  <div id="editOverlay" class="overlay" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="m-head">
        <h3>Editar dia</h3>
        <button id="btnCloseEdit" class="btn">Fechar</button>
      </div>
      <div class="m-body">
        <div class="row">
          <div class="full">
            <div class="muted" style="font-size:12px; margin-bottom:10px; font-weight:900;">
              Fiscal: <b id="eDriver"></b><br/>
              Data: <b id="eDate"></b>
            </div>
          </div>

          <div>
            <label>Tipo</label>
            <select id="eKind" class="select">
              <option value="trabalho">Trabalho</option>
              <option value="plantao">Plant√£o</option>
              <option value="ferias">F√©rias</option>
              <option value="folga">Folga</option>
              <option value="cobertura">Cobertura</option>
            </select>
          </div>

          <div>
            <label>Hora (HH:MM)</label>
            <input id="eTime" class="input" placeholder="ex: 14:00" />
          </div>

          <div class="full">
            <label>Linha</label>
            <input id="eLine" class="input" placeholder="ex: 3013-10" />
          </div>

          <!-- cobertura (s√≥ quando tipo=Folga) -->
          <div id="coverBox" class="full hidden">
            <div class="card" style="border-radius:16px; border-color:rgba(0,0,0,.10); box-shadow:none;">
              <div class="head" style="padding:10px 12px;">
                <h2 style="font-size:13px;">Cobertura desta folga</h2>
                <div class="muted" style="font-size:12px;">Ao preencher, o plantonista recebe automaticamente a linha+hora no dia dele.</div>
              </div>
              <div class="body" style="padding:10px 12px;">
                <div class="row" style="margin-bottom:0;">
                  <div>
                    <label>Matr√≠cula do plantonista</label>
                    <input id="eCoveredByMat" class="input" placeholder="ex: 30333" />
                  </div>
                  <div>
                    <label>Obs (opcional)</label>
                    <input id="eObs" class="input" placeholder="ex: falta / troca / ok" />
                  </div>
                </div>
                <div class="help" style="margin-top:8px;">
                  Importante: no calend√°rio e na linha n√£o aparece ‚ÄúCobertura‚Äù, s√≥ aparece <b>linha ‚Ä¢ hora</b>. A observa√ß√£o entra como detalhe.
                </div>
              </div>
            </div>
          </div>

        </div>
      </div>
      <div class="m-actions">
        <button id="btnClearDay" class="btn">Limpar</button>
        <button id="btnSaveDay" class="btn green">Salvar</button>
      </div>
    </div>
  </div>

  <script>
    /***********************
     * Supabase
     ***********************/
    const SUPABASE_URL = "https://cwqwugdiksfodeoksofp.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_XkISoiXR_cHRWdeKvtb7HA_ceYFTnPR";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    /***********************
     * State
     ***********************/
    let state = {
      drivers: [],
      entriesByDriverDate: new Map(), // key = driverId|YYYY-MM-DD => entry
      selectedMonth: null,
      selectedDriverId: null,
      searchText: "",
      roleFilter: "todos",
      lineFilter: "todas",
      coverageFilter: "todos",
      authed: false
    };

    /***********************
     * Helpers
     ***********************/
    const pad2 = n => String(n).padStart(2,"0");
    const ymd = (y,m,d) => `${y}-${pad2(m)}-${pad2(d)}`;
    const monthKey = (y,m) => `${y}-${pad2(m)}`;
    const parseMonthKey = (mk) => {
      const [y,m] = mk.split("-").map(Number);
      return new Date(y, m-1, 1);
    };
    const daysInMonth = (date) => new Date(date.getFullYear(), date.getMonth()+1, 0).getDate();
    const dowShort = ["DOM","SEG","TER","QUA","QUI","SEX","SAB"];

    function escapeHtml(str){
      return String(str || "")
        .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
        .replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }

    function fmtNiceDate(dateStr){
      const [y,m,d] = dateStr.split("-");
      return `${d}/${m}/${y}`;
    }

    function firstName(name){
      const s = String(name||"").trim();
      if(!s) return "";
      return s.split(/\s+/)[0];
    }

    function normalizeMat(mat){
      return String(mat||"").trim();
    }

    function keyEntry(driverId, dateStr){
      return `${driverId}|${dateStr}`;
    }

    function getEntry(driverId, dateStr){
      return state.entriesByDriverDate.get(keyEntry(driverId, dateStr)) || null;
    }

    function setEntryCache(entry){
      state.entriesByDriverDate.set(keyEntry(entry.driver_id, entry.work_date), entry);
    }

    function removeEntryCache(driverId, dateStr){
      state.entriesByDriverDate.delete(keyEntry(driverId, dateStr));
    }

    function kindLabel(kind){
      switch((kind||"").toLowerCase()){
        case "trabalho": return "Trabalho";
        case "plantao": return "Plant√£o";
        case "ferias": return "F√©rias";
        case "folga": return "Folga";
        case "cobertura": return "Cobertura";
        default: return "‚Äî";
      }
    }

    function kindChipClass(kind){
      const k = (kind||"").toLowerCase();
      if(k === "trabalho") return "chip k-trabalho";
      if(k === "plantao") return "chip k-plantao";
      if(k === "ferias") return "chip k-ferias";
      if(k === "folga") return "chip k-folga";
      if(k === "cobertura") return "chip k-cobertura";
      return "chip";
    }

    function cleanHHMM(v){
      const s = String(v||"").trim();
      if(!s) return "";
      // aceita 5 chars HH:MM
      const m = s.match(/^(\d{1,2}):(\d{2})$/);
      if(!m) return s; // se usu√°rio digitar diferente, n√£o bloqueia
      return pad2(Number(m[1])) + ":" + m[2];
    }

    function buildMainText(entry){
      // N√£o escrever "Cobertura".
      // Mostra: (se tiver linha) + (se tiver hora)
      const line = (entry?.line || "").trim();
      const time = (entry?.time_hhmm || "").trim();
      const k = (entry?.kind || "").toLowerCase();

      if(k === "ferias") return "F√©rias";
      if(k === "folga") return "Folga";
      if(k === "trabalho") return "Trabalho";

      // plantao/cobertura: foco em linha + hora
      const parts = [];
      if(line) parts.push(line);
      if(time) parts.push(time);
      if(parts.length) return parts.join(" ‚Ä¢ ");

      // fallback
      return kindLabel(entry?.kind);
    }

    function buildSubText(entry){
      // sub = observa√ß√£o (se existir)
      const obs = (entry?.obs || "").trim();
      return obs;
    }

    function isFolgaMissingCover(entry){
      if(!entry) return false;
      const k = (entry.kind||"").toLowerCase();
      if(k !== "folga") return false;
      const covered = (entry.covered_by || "").trim();
      return !covered;
    }
    function isFolgaCovered(entry){
      if(!entry) return false;
      const k = (entry.kind||"").toLowerCase();
      if(k !== "folga") return false;
      const covered = (entry.covered_by || "").trim();
      return !!covered;
    }

    function toast(msg){
      alert(msg);
    }

    /***********************
     * DB calls
     ***********************/
    async function dbLoadAllForMonth(){
      const md = state.selectedMonth;
      const y = md.getFullYear();
      const m = md.getMonth()+1;
      const from = `${y}-${pad2(m)}-01`;
      const to = `${y}-${pad2(m)}-${pad2(daysInMonth(md))}`;

      // drivers
      const { data: drivers, error: e1 } = await supabase
        .from("drivers")
        .select("*")
        .order("mat", { ascending: true });

      if(e1) throw e1;
      state.drivers = Array.isArray(drivers) ? drivers : [];

      // entries no m√™s
      const { data: entries, error: e2 } = await supabase
        .from("schedule_entries")
        .select("*")
        .gte("work_date", from)
        .lte("work_date", to);

      if(e2) throw e2;

      state.entriesByDriverDate = new Map();
      (entries || []).forEach(setEntryCache);

      refreshLineFilterOptions();
    }

    async function dbUpsertEntry(entry){
      // entry: { driver_id, work_date, kind, line, time_hhmm, covered_by, obs }
      const payload = {
        driver_id: entry.driver_id,
        work_date: entry.work_date,
        kind: entry.kind || null,
        line: (entry.line || "").trim() || null,
        time_hhmm: (entry.time_hhmm || "").trim() || null,
        covered_by: (entry.covered_by || "").trim() || null,
        obs: (entry.obs || "").trim() || null
      };

      // existe?
      const existing = getEntry(entry.driver_id, entry.work_date);
      if(existing?.id){
        const { data, error } = await supabase
          .from("schedule_entries")
          .update(payload)
          .eq("id", existing.id)
          .select()
          .single();
        if(error) throw error;
        setEntryCache(data);
        return data;
      }else{
        const { data, error } = await supabase
          .from("schedule_entries")
          .insert(payload)
          .select()
          .single();
        if(error) throw error;
        setEntryCache(data);
        return data;
      }
    }

    async function dbDeleteEntry(driverId, dateStr){
      const existing = getEntry(driverId, dateStr);
      if(!existing?.id){
        removeEntryCache(driverId, dateStr);
        return;
      }
      const { error } = await supabase
        .from("schedule_entries")
        .delete()
        .eq("id", existing.id);
      if(error) throw error;
      removeEntryCache(driverId, dateStr);
    }

    async function dbInsertDriver(driver){
      const payload = {
        mat: normalizeMat(driver.mat),
        name: (driver.name || "").trim(),
        phone: (driver.phone || "").trim() || null,
        role: (driver.role || "").trim() || "fixo",
        line_default: (driver.line_default || "").trim() || null,
        status: (driver.status || "").trim() || null
      };

      const { data, error } = await supabase
        .from("drivers")
        .insert(payload)
        .select()
        .single();
      if(error) throw error;
      state.drivers.push(data);
      state.drivers.sort((a,b)=> String(a.mat||"").localeCompare(String(b.mat||""), "pt-BR", {numeric:true}));
      refreshLineFilterOptions();
      return data;
    }

    async function dbUpdateDriver(driverId, patch){
      const payload = {
        mat: patch.mat !== undefined ? normalizeMat(patch.mat) : undefined,
        name: patch.name !== undefined ? (patch.name||"").trim() : undefined,
        phone: patch.phone !== undefined ? ((patch.phone||"").trim() || null) : undefined,
        role: patch.role !== undefined ? (patch.role||"").trim() : undefined,
        line_default: patch.line_default !== undefined ? ((patch.line_default||"").trim() || null) : undefined,
        status: patch.status !== undefined ? ((patch.status||"").trim() || null) : undefined
      };
      // remove undefined
      Object.keys(payload).forEach(k => payload[k] === undefined && delete payload[k]);

      const { data, error } = await supabase
        .from("drivers")
        .update(payload)
        .eq("id", driverId)
        .select()
        .single();
      if(error) throw error;

      state.drivers = state.drivers.map(d => d.id === driverId ? data : d);
      state.drivers.sort((a,b)=> String(a.mat||"").localeCompare(String(b.mat||""), "pt-BR", {numeric:true}));
      refreshLineFilterOptions();
      return data;
    }

    async function dbDeleteDriver(driverId){
      // apaga entries desse driver primeiro (pra evitar FK)
      const { error: e1 } = await supabase.from("schedule_entries").delete().eq("driver_id", driverId);
      if(e1) throw e1;

      const { error: e2 } = await supabase.from("drivers").delete().eq("id", driverId);
      if(e2) throw e2;

      state.drivers = state.drivers.filter(d => d.id !== driverId);

      // limpa cache do m√™s
      const keysToRemove = [];
      for(const [k,v] of state.entriesByDriverDate.entries()){
        if(v.driver_id === driverId) keysToRemove.push(k);
      }
      keysToRemove.forEach(k => state.entriesByDriverDate.delete(k));

      refreshLineFilterOptions();
    }

    /***********************
     * Auto-cobertura (folga -> alimenta plantonista)
     ***********************/
    async function applyCoverageIfNeeded(fixoDriverId, workDate, kind, line, time, coveredByMat, obs){
      const k = (kind||"").toLowerCase();
      if(k !== "folga") return;

      const mat = normalizeMat(coveredByMat);
      if(!mat) return;

      const plant = state.drivers.find(d => normalizeMat(d.mat) === mat);
      if(!plant){
        // n√£o bloqueia salvar folga, s√≥ avisa
        toast("Aten√ß√£o: matr√≠cula do plantonista n√£o encontrada no cadastro. Cadastre ele primeiro.");
        return;
      }

      // cria/atualiza entrada no plantonista no mesmo dia: kind=cobertura, line+time
      const fixo = state.drivers.find(d => d.id === fixoDriverId);
      const autoObs = (() => {
        const base = fixo ? `c/${normalizeMat(fixo.mat)} ${firstName(fixo.name)}` : "";
        const user = (obs||"").trim();
        if(base && user) return `${base} ‚Ä¢ ${user}`;
        return base || user;
      })();

      await dbUpsertEntry({
        driver_id: plant.id,
        work_date: workDate,
        kind: "cobertura",
        line: (line||"").trim(),
        time_hhmm: (time||"").trim(),
        covered_by: null,   // n√£o precisa
        obs: autoObs || null
      });
    }

    /***********************
     * UI refs
     ***********************/
    const loginView = document.getElementById("loginView");
    const appView = document.getElementById("appView");
    const loginEmail = document.getElementById("loginEmail");
    const loginPass = document.getElementById("loginPass");
    const loginErr = document.getElementById("loginErr");
    const btnLogin = document.getElementById("btnLogin");

    const btnLogout = document.getElementById("btnLogout");
    const monthPicker = document.getElementById("monthPicker");
    const searchMat = document.getElementById("searchMat");
    const roleFilter = document.getElementById("roleFilter");
    const lineFilter = document.getElementById("lineFilter");
    const coverageFilter = document.getElementById("coverageFilter");

    const btnAddDriver = document.getElementById("btnAddDriver");
    const btnExportCSV = document.getElementById("btnExportCSV");
    const btnExportPDF = document.getElementById("btnExportPDF");

    const monthThead = document.getElementById("monthThead");
    const monthTbody = document.getElementById("monthTbody");

    const footerStatus = document.getElementById("footerStatus");

    const drawer = document.getElementById("drawer");
    const btnCloseDrawer = document.getElementById("btnCloseDrawer");
    const btnRemoveDriver = document.getElementById("btnRemoveDriver");
    const btnPng = document.getElementById("btnPng");
    const btnPdfCal = document.getElementById("btnPdfCal");
    const dName = document.getElementById("dName");
    const dSub = document.getElementById("dSub");
    const calGrid = document.getElementById("calGrid");

    const addOverlay = document.getElementById("addOverlay");
    const btnCloseAdd = document.getElementById("btnCloseAdd");
    const btnSaveDriver = document.getElementById("btnSaveDriver");
    const inMat = document.getElementById("inMat");
    const inName = document.getElementById("inName");
    const inPhone = document.getElementById("inPhone");
    const inRole = document.getElementById("inRole");
    const inLineDefault = document.getElementById("inLineDefault");
    const inStatus = document.getElementById("inStatus");

    const editOverlay = document.getElementById("editOverlay");
    const btnCloseEdit = document.getElementById("btnCloseEdit");
    const btnSaveDay = document.getElementById("btnSaveDay");
    const btnClearDay = document.getElementById("btnClearDay");
    const eDriver = document.getElementById("eDriver");
    const eDate = document.getElementById("eDate");
    const eKind = document.getElementById("eKind");
    const eLine = document.getElementById("eLine");
    const eTime = document.getElementById("eTime");
    const coverBox = document.getElementById("coverBox");
    const eCoveredByMat = document.getElementById("eCoveredByMat");
    const eObs = document.getElementById("eObs");

    let editCtx = { driverId:null, dateStr:null };

    /***********************
     * Auth + init
     ***********************/
    function show(el){ el.classList.remove("hidden"); }
    function hide(el){ el.classList.add("hidden"); }

    function ensureMonthInit(){
      if(!state.selectedMonth){
        const now = new Date();
        state.selectedMonth = new Date(now.getFullYear(), now.getMonth(), 1);
      }
      monthPicker.value = monthKey(state.selectedMonth.getFullYear(), state.selectedMonth.getMonth()+1);
    }

    async function refreshApp(){
      ensureMonthInit();
      footerStatus.textContent = "‚è≥ Carregando dados do Supabase‚Ä¶";
      await dbLoadAllForMonth();
      footerStatus.textContent = "‚úÖ Dados salvos no Supabase (nuvem). Exporta√ß√£o: Excel (CSV) e PDF.";
      renderAll();
    }

    async function handleLogin(){
      const email = (loginEmail.value||"").trim();
      const pass = (loginPass.value||"").trim();

      loginErr.style.display = "none";
      btnLogin.disabled = true;
      btnLogin.textContent = "Entrando‚Ä¶";

      try{
        const { data, error } = await supabase.auth.signInWithPassword({ email, password: pass });
        if(error) throw error;
        state.authed = true;

        hide(loginView);
        show(appView);

        await refreshApp();
      }catch(e){
        loginErr.style.display = "block";
        console.error(e);
      }finally{
        btnLogin.disabled = false;
        btnLogin.textContent = "Entrar";
      }
    }

    btnLogin.addEventListener("click", handleLogin);
    loginPass.addEventListener("keydown", (e) => { if(e.key === "Enter") handleLogin(); });
    loginEmail.addEventListener("keydown", (e) => { if(e.key === "Enter") handleLogin(); });

    btnLogout.addEventListener("click", async () => {
      await supabase.auth.signOut();
      state.authed = false;
      closeDrawer();
      hide(appView);
      show(loginView);
      footerStatus.textContent = "‚è≥ Conectando‚Ä¶";
    });

    /***********************
     * Filters
     ***********************/
    searchMat.addEventListener("input", () => {
      state.searchText = (searchMat.value || "").trim().toLowerCase();
      renderTable();
    });

    roleFilter.addEventListener("change", () => {
      state.roleFilter = roleFilter.value;
      renderTable();
    });

    lineFilter.addEventListener("change", () => {
      state.lineFilter = lineFilter.value;
      renderTable();
    });

    coverageFilter.addEventListener("change", () => {
      state.coverageFilter = coverageFilter.value;
      renderTable();
    });

    monthPicker.addEventListener("change", async () => {
      if(!monthPicker.value) return;
      state.selectedMonth = parseMonthKey(monthPicker.value);
      await refreshApp();
      if(drawer.classList.contains("open")){
        renderCalendar();
      }
    });

    function refreshLineFilterOptions(){
      // linhas poss√≠veis: drivers.line_default + schedule_entries.line do m√™s
      const set = new Set();
      state.drivers.forEach(d => { if((d.line_default||"").trim()) set.add((d.line_default||"").trim()); });

      const md = state.selectedMonth;
      if(md){
        const y = md.getFullYear();
        const m = md.getMonth()+1;
        const nDays = daysInMonth(md);
        for(const drv of state.drivers){
          for(let d=1; d<=nDays; d++){
            const dt = ymd(y,m,d);
            const e = getEntry(drv.id, dt);
            const line = (e?.line||"").trim();
            if(line) set.add(line);
          }
        }
      }

      const lines = Array.from(set).sort((a,b)=> a.localeCompare(b, "pt-BR", {numeric:true}));
      const cur = state.lineFilter;

      const opts = [`<option value="todas">Todas</option>`].concat(
        lines.map(l => `<option value="${escapeHtml(l)}">${escapeHtml(l)}</option>`)
      );

      lineFilter.innerHTML = opts.join("");
      // re-seleciona se poss√≠vel
      if(cur !== "todas" && lines.includes(cur)){
        lineFilter.value = cur;
      }else{
        state.lineFilter = "todas";
        lineFilter.value = "todas";
      }
    }

    /***********************
     * Overlays
     ***********************/
    function openAdd(){
      addOverlay.classList.add("show");
      inMat.value = "";
      inName.value = "";
      inPhone.value = "";
      inRole.value = "fixo";
      inLineDefault.value = "";
      inStatus.value = "Dispon√≠vel";
      setTimeout(() => inMat.focus(), 50);
    }
    function closeAdd(){ addOverlay.classList.remove("show"); }

    btnAddDriver.addEventListener("click", openAdd);
    btnCloseAdd.addEventListener("click", closeAdd);
    addOverlay.addEventListener("click", (e)=>{ if(e.target === addOverlay) closeAdd(); });

    btnSaveDriver.addEventListener("click", async () => {
      const mat = normalizeMat(inMat.value);
      const name = (inName.value || "").trim();
      const phone = (inPhone.value || "").trim();
      const role = (inRole.value || "").trim();
      const line_default = (inLineDefault.value || "").trim();
      const status = (inStatus.value || "").trim();

      if(!mat || !name){
        toast("Preencha pelo menos Matr√≠cula e Nome.");
        return;
      }
      const exists = state.drivers.some(d => normalizeMat(d.mat) === mat);
      if(exists){
        toast("J√° existe um fiscal com essa matr√≠cula.");
        return;
      }

      btnSaveDriver.disabled = true;
      btnSaveDriver.textContent = "Salvando‚Ä¶";
      try{
        await dbInsertDriver({ mat, name, phone, role, line_default, status });
        closeAdd();
        renderAll();
      }catch(e){
        console.error(e);
        toast("Erro ao salvar fiscal: " + (e?.message || e));
      }finally{
        btnSaveDriver.disabled = false;
        btnSaveDriver.textContent = "Salvar";
      }
    });

    function openEdit(driverId, dateStr){
      editCtx = { driverId, dateStr };
      const drv = state.drivers.find(d => d.id === driverId);

      eDriver.textContent = drv ? `${drv.mat} ‚Ä¢ ${drv.name}` : "";
      eDate.textContent = fmtNiceDate(dateStr);

      const entry = getEntry(driverId, dateStr);
      eKind.value = (entry?.kind || "trabalho").toLowerCase();
      eLine.value = (entry?.line || "").trim() || (drv?.line_default || "").trim();
      eTime.value = (entry?.time_hhmm || "").trim();
      eCoveredByMat.value = (entry?.covered_by || "").trim();
      eObs.value = (entry?.obs || "").trim();

      coverBox.classList.toggle("hidden", eKind.value !== "folga");
      editOverlay.classList.add("show");
      setTimeout(() => eKind.focus(), 50);
    }
    function closeEdit(){
      editOverlay.classList.remove("show");
      editCtx = { driverId:null, dateStr:null };
    }

    eKind.addEventListener("change", () => {
      coverBox.classList.toggle("hidden", eKind.value !== "folga");
      if(eKind.value !== "folga"){
        eCoveredByMat.value = "";
      }
    });

    btnCloseEdit.addEventListener("click", closeEdit);
    editOverlay.addEventListener("click", (e)=>{ if(e.target === editOverlay) closeEdit(); });

    btnSaveDay.addEventListener("click", async () => {
      if(!editCtx.driverId || !editCtx.dateStr) return;

      const driverId = editCtx.driverId;
      const dateStr = editCtx.dateStr;

      const kind = (eKind.value || "").trim().toLowerCase();
      const line = (eLine.value || "").trim();
      const time = cleanHHMM(eTime.value);
      const coveredBy = (kind === "folga") ? normalizeMat(eCoveredByMat.value) : "";
      const obs = (eObs.value || "").trim();

      btnSaveDay.disabled = true;
      btnSaveDay.textContent = "Salvando‚Ä¶";
      try{
        const saved = await dbUpsertEntry({
          driver_id: driverId,
          work_date: dateStr,
          kind,
          line,
          time_hhmm: time,
          covered_by: coveredBy,
          obs
        });

        // Se for folga e preencher cobertura: alimenta o plantonista no MESMO DIA
        if(kind === "folga" && coveredBy){
          await applyCoverageIfNeeded(driverId, dateStr, kind, line, time, coveredBy, obs);
        }

        closeEdit();
        refreshLineFilterOptions();
        renderAll();
      }catch(e){
        console.error(e);
        toast("Erro ao salvar dia: " + (e?.message || e));
      }finally{
        btnSaveDay.disabled = false;
        btnSaveDay.textContent = "Salvar";
      }
    });

    btnClearDay.addEventListener("click", async () => {
      if(!editCtx.driverId || !editCtx.dateStr) return;
      btnClearDay.disabled = true;
      btnClearDay.textContent = "Limpando‚Ä¶";
      try{
        await dbDeleteEntry(editCtx.driverId, editCtx.dateStr);
        closeEdit();
        refreshLineFilterOptions();
        renderAll();
      }catch(e){
        console.error(e);
        toast("Erro ao limpar: " + (e?.message || e));
      }finally{
        btnClearDay.disabled = false;
        btnClearDay.textContent = "Limpar";
      }
    });

    /***********************
     * Drawer
     ***********************/
    function openDrawer(driverId){
      state.selectedDriverId = driverId;
      const drv = state.drivers.find(d => d.id === driverId);
      if(!drv) return;

      dName.textContent = `${drv.mat} ‚Ä¢ ${drv.name}`;
      const meta = [
        drv.role ? `üë§ ${drv.role}` : null,
        drv.line_default ? `üöå ${drv.line_default}` : `üöå (sem linha fixa)`,
        drv.status ? `üè∑Ô∏è ${drv.status}` : `üè∑Ô∏è (sem status)`
      ].filter(Boolean);

      dSub.innerHTML = meta.map(m => `<span class="tag">${escapeHtml(m)}</span>`).join(" ");

      drawer.classList.add("open");      // j√° √© ‚Äútela cheia‚Äù
      drawer.setAttribute("aria-hidden","false");
      renderCalendar();
    }

    function closeDrawer(){
      state.selectedDriverId = null;
      drawer.classList.remove("open");
      drawer.setAttribute("aria-hidden","true");
    }

    btnCloseDrawer.addEventListener("click", closeDrawer);

    btnRemoveDriver.addEventListener("click", async () => {
      const id = state.selectedDriverId;
      if(!id) return;
      const drv = state.drivers.find(d => d.id === id);
      if(!drv) return;

      const ok = confirm(`Remover o fiscal ${drv.mat} ‚Ä¢ ${drv.name}? (apaga tamb√©m os dias dele)`);
      if(!ok) return;

      btnRemoveDriver.disabled = true;
      btnRemoveDriver.textContent = "Removendo‚Ä¶";
      try{
        await dbDeleteDriver(id);
        closeDrawer();
        renderAll();
      }catch(e){
        console.error(e);
        toast("Erro ao remover: " + (e?.message || e));
      }finally{
        btnRemoveDriver.disabled = false;
        btnRemoveDriver.textContent = "Remover";
      }
    });

    /***********************
     * Captura PNG + PDF do calend√°rio (sem cortar)
     ***********************/
    async function captureCalendarCanvas(){
      const el = document.getElementById("calCapture");
      if(!el) throw new Error("Calend√°rio n√£o encontrado.");

      // modo captura (alto contraste)
      document.body.classList.add("capture-mode");

      // garante que o elemento esteja vis√≠vel e no topo
      drawer.scrollTop = 0;
      el.scrollIntoView({ block: "start" });

      // qualidade alta e sem cortar
      const canvas = await html2canvas(el, {
        backgroundColor: "#ffffff",
        scale: 2.2,
        useCORS: true,
        windowWidth: document.documentElement.clientWidth,
        windowHeight: document.documentElement.clientHeight
      });

      document.body.classList.remove("capture-mode");
      return canvas;
    }

    function downloadDataUrl(dataUrl, filename){
      const a = document.createElement("a");
      a.href = dataUrl;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
    }

    btnPng.addEventListener("click", async () => {
      const id = state.selectedDriverId;
      if(!id) return;
      const drv = state.drivers.find(d => d.id === id);
      if(!drv) return;

      btnPng.disabled = true;
      btnPng.textContent = "Gerando‚Ä¶";
      try{
        const canvas = await captureCalendarCanvas();
        const y = state.selectedMonth.getFullYear();
        const m = pad2(state.selectedMonth.getMonth()+1);
        const filename = `calendario-${drv.mat}-${y}-${m}.png`;
        downloadDataUrl(canvas.toDataURL("image/png", 1.0), filename);
      }catch(e){
        console.error(e);
        toast("Erro ao gerar PNG: " + (e?.message || e));
      }finally{
        btnPng.disabled = false;
        btnPng.textContent = "üñºÔ∏è Baixar PNG (calend√°rio)";
      }
    });

    btnPdfCal.addEventListener("click", async () => {
      const id = state.selectedDriverId;
      if(!id) return;
      const drv = state.drivers.find(d => d.id === id);
      if(!drv) return;

      btnPdfCal.disabled = true;
      btnPdfCal.textContent = "Gerando‚Ä¶";
      try{
        const canvas = await captureCalendarCanvas();
        const imgData = canvas.toDataURL("image/png", 1.0);

        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF({ orientation: "landscape", unit: "pt", format: "a4" });

        const pageW = pdf.internal.pageSize.getWidth();
        const pageH = pdf.internal.pageSize.getHeight();

        // encaixa a imagem na p√°gina mantendo propor√ß√£o
        const imgW = canvas.width;
        const imgH = canvas.height;
        const scale = Math.min(pageW / imgW, pageH / imgH);
        const w = imgW * scale;
        const h = imgH * scale;
        const x = (pageW - w) / 2;
        const y = (pageH - h) / 2;

        pdf.addImage(imgData, "PNG", x, y, w, h);

        const yy = state.selectedMonth.getFullYear();
        const mm = pad2(state.selectedMonth.getMonth()+1);
        pdf.save(`calendario-${drv.mat}-${yy}-${mm}.pdf`);
      }catch(e){
        console.error(e);
        toast("Erro ao exportar PDF: " + (e?.message || e));
      }finally{
        btnPdfCal.disabled = false;
        btnPdfCal.textContent = "üßæ PDF (calend√°rio)";
      }
    });

    /***********************
     * Export CSV (Excel) - formato ‚Äúcertinho‚Äù (1 linha por dia com conte√∫do)
     ***********************/
    function csvEscape(v){
      const s = String(v ?? "");
      // always quote (Excel)
      return `"${s.replaceAll('"','""')}"`;
    }

    function buildCsvForMonth(){
      const md = state.selectedMonth;
      const y = md.getFullYear();
      const m = md.getMonth()+1;
      const nDays = daysInMonth(md);

      const header = [
        "matricula",
        "nome",
        "tipo",
        "linha_fixa",
        "status",
        "dia",
        "dia_semana",
        "tipo_dia",
        "linha",
        "hora",
        "coberto_por",
        "obs"
      ];

      const rows = [header.map(csvEscape).join(",")];

      // exporta ‚Äúlistagem normal‚Äù: todos (respeita filtros atuais)
      const drivers = getFilteredDrivers();

      for(const d of drivers){
        for(let day=1; day<=nDays; day++){
          const dt = new Date(y, m-1, day);
          const dateStr = ymd(y,m,day);
          const dow = dowShort[dt.getDay()];

          const e = getEntry(d.id, dateStr);
          if(!e) continue; // s√≥ exporta o que foi preenchido (fica leve e ‚Äúnormal‚Äù)

          rows.push([
            d.mat,
            d.name,
            d.role,
            d.line_default || "",
            d.status || "",
            dateStr,
            dow,
            (e.kind || ""),
            (e.line || ""),
            (e.time_hhmm || ""),
            (e.covered_by || ""),
            (e.obs || "")
          ].map(csvEscape).join(","));
        }
      }

      // BOM para Excel abrir acentos
      return "\uFEFF" + rows.join("\n");
    }

    function downloadText(text, filename, mime="text/plain"){
      const blob = new Blob([text], { type: mime + ";charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(()=>URL.revokeObjectURL(url), 6000);
    }

    btnExportCSV.addEventListener("click", () => {
      const y = state.selectedMonth.getFullYear();
      const m = pad2(state.selectedMonth.getMonth()+1);
      const csv = buildCsvForMonth();
      downloadText(csv, `escala-${y}-${m}.csv`, "text/csv");
    });

    /***********************
     * Export PDF geral (da lista do m√™s) - ‚ÄúPDF real‚Äù
     ***********************/
    btnExportPDF.addEventListener("click", async () => {
      btnExportPDF.disabled = true;
      btnExportPDF.textContent = "Gerando‚Ä¶";
      try{
        // captura a tabela inteira (card 1)
        const el = document.querySelector(".grid .card");
        if(!el) throw new Error("Tabela n√£o encontrada.");

        // modo captura clareia o fundo (j√° √© claro, mas garante)
        document.body.classList.add("capture-mode");
        window.scrollTo({ top: 0, behavior: "instant" });

        const canvas = await html2canvas(el, {
          backgroundColor: "#ffffff",
          scale: 2,
          useCORS: true,
          windowWidth: document.documentElement.clientWidth
        });

        document.body.classList.remove("capture-mode");

        const imgData = canvas.toDataURL("image/png", 1.0);
        const { jsPDF } = window.jspdf;

        // PDF A4 landscape para caber mais dias
        const pdf = new jsPDF({ orientation: "landscape", unit: "pt", format: "a4" });

        const pageW = pdf.internal.pageSize.getWidth();
        const pageH = pdf.internal.pageSize.getHeight();

        const imgW = canvas.width;
        const imgH = canvas.height;

        // se a tabela ficar muito alta, divide em p√°ginas
        const scale = pageW / imgW;
        const scaledH = imgH * scale;

        if(scaledH <= pageH){
          pdf.addImage(imgData, "PNG", 0, 0, pageW, scaledH);
        }else{
          // paginar por ‚Äúfatias‚Äù
          let yOffset = 0;
          const sliceH = pageH / scale;

          while(yOffset < imgH){
            const sliceCanvas = document.createElement("canvas");
            sliceCanvas.width = imgW;
            sliceCanvas.height = Math.min(sliceH, imgH - yOffset);

            const ctx = sliceCanvas.getContext("2d");
            ctx.drawImage(canvas, 0, yOffset, imgW, sliceCanvas.height, 0, 0, imgW, sliceCanvas.height);

            const sliceData = sliceCanvas.toDataURL("image/png", 1.0);
            if(yOffset > 0) pdf.addPage();
            pdf.addImage(sliceData, "PNG", 0, 0, pageW, sliceCanvas.height * scale);

            yOffset += sliceH;
          }
        }

        const yy = state.selectedMonth.getFullYear();
        const mm = pad2(state.selectedMonth.getMonth()+1);
        pdf.save(`lista-mes-${yy}-${mm}.pdf`);
      }catch(e){
        console.error(e);
        toast("Erro ao exportar PDF: " + (e?.message || e));
      }finally{
        btnExportPDF.disabled = false;
        btnExportPDF.textContent = "üßæ PDF";
      }
    });

    /***********************
     * Rendering
     ***********************/
    function getFilteredDrivers(){
      const txt = state.searchText;

      // filtro de linha: ‚Äúa escala irei fazer por linha‚Äù
      // l√≥gica: considera linha_fixa do fiscal OU linha do dia (no m√™s) quando preenchida.
      const md = state.selectedMonth;
      const y = md.getFullYear();
      const m = md.getMonth()+1;
      const nDays = daysInMonth(md);

      function driverHasLineInMonth(driver, line){
        if(!line || line === "todas") return true;

        const ld = (driver.line_default || "").trim();
        if(ld === line) return true;

        for(let d=1; d<=nDays; d++){
          const dt = ymd(y,m,d);
          const e = getEntry(driver.id, dt);
          if((e?.line||"").trim() === line) return true;
        }
        return false;
      }

      return state.drivers
        .slice()
        .sort((a,b)=> String(a.mat||"").localeCompare(String(b.mat||""), "pt-BR", {numeric:true}))
        .filter(d => {
          // tipo
          if(state.roleFilter !== "todos"){
            if((d.role||"").toLowerCase().trim() !== state.roleFilter) return false;
          }

          // busca
          if(txt){
            const mat = String(d.mat||"").toLowerCase();
            const name = String(d.name||"").toLowerCase();
            if(!mat.includes(txt) && !name.includes(txt)) return false;
          }

          // linha
          if(state.lineFilter !== "todas"){
            if(!driverHasLineInMonth(d, state.lineFilter)) return false;
          }

          // filtro de folgas cobertas/faltando:
          if(state.coverageFilter !== "todos"){
            // aplica no n√≠vel do fiscal fixo (se ele tiver ao menos 1 folga naquele status)
            let hasMatch = false;
            for(let day=1; day<=nDays; day++){
              const dt = ymd(y,m,day);
              const e = getEntry(d.id, dt);
              if(state.coverageFilter === "folgas_faltando" && isFolgaMissingCover(e)) hasMatch = true;
              if(state.coverageFilter === "folgas_cobertas" && isFolgaCovered(e)) hasMatch = true;
              if(hasMatch) break;
            }
            if(!hasMatch) return false;
          }

          return true;
        });
    }

    function renderAll(){
      renderTable();
      if(drawer.classList.contains("open")){
        renderCalendar();
      }
    }

    function renderTable(){
      const monthDate = state.selectedMonth;
      const y = monthDate.getFullYear();
      const m = monthDate.getMonth()+1;
      const nDays = daysInMonth(monthDate);

      // Header
      const th = [];
      th.push(`<tr>`);
      th.push(`<th class="col-driver">Matr√≠cula ‚Ä¢ Nome ‚Ä¢ Tipo ‚Ä¢ Linha fixa ‚Ä¢ Status</th>`);
      for(let d=1; d<=nDays; d++){
        const dt = new Date(y, m-1, d);
        const dow = dowShort[dt.getDay()];
        th.push(`<th title="${dow}">${pad2(d)}<div style="color:rgba(54,90,71,.8);font-weight:900;font-size:11px;margin-top:2px;">${dow}</div></th>`);
      }
      th.push(`</tr>`);
      monthThead.innerHTML = th.join("");

      const filtered = getFilteredDrivers();

      const rows = [];
      if(filtered.length === 0){
        rows.push(`<tr><td class="col-driver"><span class="muted">Nenhum fiscal encontrado.</span></td>${"<td></td>".repeat(nDays)}</tr>`);
        monthTbody.innerHTML = rows.join("");
        return;
      }

      for(const drv of filtered){
        const tags = `
          <div class="driver-meta">
            <span class="tag">üë§ ${escapeHtml(drv.role || "‚Äî")}</span>
            <span class="tag">üöå ${escapeHtml(drv.line_default || "(sem linha fixa)")}</span>
            <span class="tag">üè∑Ô∏è ${escapeHtml(drv.status || "Dispon√≠vel")}</span>
            <span class="tag" style="opacity:.85">Clique no nome ‚Üí calend√°rio</span>
          </div>
        `;

        const title = `
          <div class="driver-title">
            <div class="name">${escapeHtml(drv.mat)} ‚Ä¢ ${escapeHtml(firstName(drv.name) ? (drv.name) : drv.name)}</div>
            ${tags}
          </div>
        `;

        rows.push(`<tr>`);
        rows.push(`<td class="col-driver" style="cursor:pointer;" data-open="${drv.id}">${title}</td>`);

        for(let d=1; d<=nDays; d++){
          const dateStr = ymd(y,m,d);
          const entry = getEntry(drv.id, dateStr);

          if(!entry){
            rows.push(`<td><span class="chip empty" data-edit="${drv.id}" data-date="${dateStr}" title="Clique para editar"><span class="main">‚Äî</span></span></td>`);
            continue;
          }

          const cls = kindChipClass(entry.kind);
          const main = escapeHtml(buildMainText(entry));
          const sub = escapeHtml(buildSubText(entry));

          rows.push(`
            <td>
              <span class="${cls}" data-edit="${drv.id}" data-date="${dateStr}" title="Clique para editar">
                <span class="main">${main}</span>
                ${sub ? `<span class="sub">${sub}</span>` : ``}
              </span>
            </td>
          `);
        }

        rows.push(`</tr>`);
      }

      monthTbody.innerHTML = rows.join("");

      monthTbody.querySelectorAll("[data-open]").forEach(el => {
        el.addEventListener("click", () => openDrawer(el.getAttribute("data-open")));
      });

      monthTbody.querySelectorAll("[data-edit]").forEach(el => {
        el.addEventListener("click", (e) => {
          e.stopPropagation();
          openEdit(el.getAttribute("data-edit"), el.getAttribute("data-date"));
        });
      });
    }

    function renderCalendar(){
      const id = state.selectedDriverId;
      const drv = state.drivers.find(d => d.id === id);
      if(!drv) return;

      const monthDate = state.selectedMonth;
      const y = monthDate.getFullYear();
      const m = monthDate.getMonth()+1;
      const nDays = daysInMonth(monthDate);

      const firstDow = new Date(y, m-1, 1).getDay();
      const cells = [];

      for(let i=0; i<firstDow; i++){
        cells.push(`<div class="day muted" aria-hidden="true"></div>`);
      }

      for(let d=1; d<=nDays; d++){
        const dateStr = ymd(y,m,d);
        const entry = getEntry(id, dateStr);

        if(!entry){
          cells.push(`
            <div class="day" data-editcal="${dateStr}">
              <div class="num">${pad2(d)}</div>
              <div class="val empty"><span class="main">Dispon√≠vel</span></div>
            </div>
          `);
          continue;
        }

        const main = escapeHtml(buildMainText(entry));
        const sub = escapeHtml(buildSubText(entry));

        // cor do ‚Äúval‚Äù conforme tipo
        const k = (entry.kind||"").toLowerCase();
        let bg = "rgba(255,255,255,.90)", br = "rgba(0,0,0,.12)";
        if(k==="trabalho"){ bg = "var(--k-trabalho-bg)"; br="rgba(0,196,106,.55)"; }
        if(k==="plantao"){ bg = "var(--k-plantao-bg)"; br="rgba(0,166,255,.55)"; }
        if(k==="ferias"){ bg = "var(--k-ferias-bg)"; br="rgba(255,62,168,.55)"; }
        if(k==="folga"){ bg = "var(--k-folga-bg)"; br="rgba(243,183,0,.60)"; }
        if(k==="cobertura"){ bg = "var(--k-cobertura-bg)"; br="rgba(138,43,226,.55)"; }

        cells.push(`
          <div class="day" data-editcal="${dateStr}">
            <div class="num">${pad2(d)}</div>
            <div class="val" style="background:${bg}; border-color:${br}">
              <span class="main">${main}</span>
              ${sub ? `<span class="sub">${sub}</span>` : ``}
            </div>
          </div>
        `);
      }

      const totalCells = firstDow + nDays;
      const tail = (7 - (totalCells % 7)) % 7;
      for(let i=0; i<tail; i++){
        cells.push(`<div class="day muted" aria-hidden="true"></div>`);
      }

      calGrid.innerHTML = cells.join("");

      calGrid.querySelectorAll("[data-editcal]").forEach(el => {
        el.addEventListener("click", () => openEdit(id, el.getAttribute("data-editcal")));
      });
    }

    /***********************
     * Auto-session: se j√° estiver logado no Supabase, entra direto
     ***********************/
    (async function boot(){
      ensureMonthInit();
      hide(appView);
      show(loginView);

      const { data } = await supabase.auth.getSession();
      if(data?.session){
        state.authed = true;
        hide(loginView);
        show(appView);
        await refreshApp();
      }else{
        // pr√©-preenche o email que voc√™ informou (facilita)
        loginEmail.value = "darlene.plantao@pessegotransportes.com.br";
        setTimeout(()=>loginPass.focus(), 50);
      }
    })();
  </script>
</body>
</html>
